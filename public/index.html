<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>My Game Library</title>
    <!--
        Main SPA shell for the Video Game Database app.
        This file contains the static structure: header, tabs, controls, display grid,
        and modal dialogs. JavaScript in `/js/app.js` will wire up behavior.
        The UI uses a dark theme provided by `/css/style.css`.
    -->
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- App container -->
    <div id="app" class="app-root">
        <!-- Header with title, search and action buttons -->
        <header class="app-header">
            <div class="title-area">
                <h1 id="app-title">My Game Library</h1>
                <p class="subtitle">A personal catalog for the games you love</p>
            </div>

            <div class="header-controls">
                <!-- Search container for autocomplete -->
                <div id="search-container" class="search-container">
                    <div style="display:flex;align-items:center;gap:8px">
                        <input id="search-input" class="search-input" type="search" placeholder="Search for games, tags, platforms..." aria-label="Search" autocomplete="off" />
                        <div class="help-icon" tabindex="0" aria-label="Search help">?
                            <div class="help-tooltip">Type to search. Use "exact phrase" for exact match.</div>
                        </div>
                    </div>
                    <div id="autocomplete-results" class="autocomplete-results"></div>
                </div>

                <!-- Primary action buttons -->
                <div class="button-group">
                    <button id="btn-add-game" class="btn btn-primary">Add Game</button>
                    <button id="btn-add-platform" class="btn">Add Platform</button>
                    <button id="btn-import-csv" class="btn">Import from CSV</button>
                </div>
            </div>
        </header>

        <!-- Main area containing tabs, controls and display grid -->
        <main class="main-area">
            <!-- Tabs -->
            <nav class="tabs" role="tablist">
                <button class="tab active" data-tab="games" role="tab" aria-selected="true">Games <span class="tab-count"></span></button>
                <button class="tab" data-tab="platforms" role="tab" aria-selected="false">Platforms <span class="tab-count"></span></button>
            </nav>

            <!-- Controls bar: sorting + filtering -->
            <section class="controls-bar">
                <div class="left-controls">
                    <label for="sort-select">Sort by:</label>
                    <select id="sort-select">
                        <option value="name_asc" selected>Name (A-Z)</option>
                        <option value="name_desc">Name (Z-A)</option>
                        <option value="year_desc">Release Year (Newest)</option>
                        <option value="year_asc">Release Year (Oldest)</option>
                        <option value="date_added_desc">Date Added (Newest)</option>
                        <option value="date_added_asc">Date Added (Oldest)</option>
                        <option value="platform_count_desc">Platforms (Most)</option>
                        <option value="platform_count_asc">Platforms (Fewest)</option>
                    </select>
                    <label for="items-per-page-select">Per Page:</label>
                    <select id="items-per-page-select">
                        <option value="12">12</option>
                        <option value="24" selected>24</option>
                        <option value="48">48</option>
                        <option value="96">96</option>
                    </select>
                </div>

                <div class="right-controls" id="games-controls">
                    <button id="btn-select-multiple" class="btn btn-sm">‚òë Select</button>
                    <button id="btn-filter" class="btn btn-sm">üîç Filter</button>
                    <button id="btn-display" class="btn btn-sm">üñº Display</button>
                    <span id="active-filters" class="active-filters"></span>
                </div>
            </section>
            
            <!-- Bulk actions bar (hidden by default) -->
            <section id="bulk-actions-bar" class="bulk-actions-bar" style="display: none;">
                <span id="bulk-actions-count"></span>
                <button id="bulk-select-all-filtered" class="btn btn-sm">Select All (Filtered)</button>
                <button id="bulk-select-page" class="btn btn-sm">Select Page</button>
                <button id="bulk-select-none" class="btn btn-sm">Select None</button>
                <button id="bulk-select-inverse" class="btn btn-sm">Inverse Selection</button>
                <button id="bulk-action-edit" class="btn btn-sm btn-primary">Edit Selected...</button>
            </section>

            <section id="pagination-top" class="pagination-controls"></section>

            <!-- Display grid: cards will be rendered here via JS -->
            <section id="display-grid" class="display-grid" aria-live="polite">
                <!-- Cards will be dynamically rendered by JavaScript -->
            </section>

            <!-- Bottom pagination controls -->
            <section id="pagination-bottom" class="pagination-controls">
            </section>
        </main>
    </div>

    <!-- Modals (hidden by default) -->
    <!-- Add / Edit Game Modal -->
    <div id="modal-game" class="modal" aria-hidden="true">
        <div class="modal-content">
            <header class="modal-header">
                <h2 id="modal-game-title">Add / Edit Game</h2>
                <button class="modal-close" data-close>&times;</button>
            </header>
            <form id="form-game" class="modal-form" data-id-holder>
                <div style="position: relative;">
                    <label>Game Title<input type="text" name="name" required autocomplete="off"></label>
                    <div id="add-game-autocomplete-results" class="autocomplete-results modal-autocomplete"></div>
                </div>
                <label>Description<textarea name="description"></textarea></label>
                <label>Release Year<input type="number" name="release_year" min="1970" max="2100"></label>
                <label>Cover Image URL<input type="text" name="cover_image_url" placeholder="e.g., /img/cover.svg or https://..."></label>
                <label>Trailer URL<input type="text" name="trailer_url" placeholder="e.g., /trailers/promo.mp4 or https://..."></label>
                <label>Tags (comma-separated)<input type="text" name="tags" placeholder="e.g., action, RPG, indie"></label>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <label>IGDB ID<input type="number" name="igdb_id" placeholder="e.g., 12345"></label>
                    <label>ESRB Rating
                        <select name="esrb_rating">
                            <option value="">Not Rated</option>
                            <option value="E">E - Everyone</option>
                            <option value="E10+">E10+ - Everyone 10+</option>
                            <option value="T">T - Teen</option>
                            <option value="M">M - Mature 17+</option>
                            <option value="AO">AO - Adults Only 18+</option>
                            <option value="RP">RP - Rating Pending</option>
                        </select>
                    </label>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <label>Genre<input type="text" name="genre" placeholder="e.g., Action, RPG, Strategy"></label>
                    <label>Target Audience<input type="text" name="target_audience" placeholder="e.g., Casual, Hardcore, Family"></label>
                </div>
                
                <label>Developer(s) (comma-separated)<input type="text" name="developers" placeholder="e.g., Nintendo, Valve, CD Projekt Red"></label>
                <label>Publisher(s) (comma-separated)<input type="text" name="publishers" placeholder="e.g., EA, Ubisoft, Sony"></label>
                <label>Plot Synopsis<textarea name="plot_synopsis" rows="3" placeholder="Brief description of the game's story..."></textarea></label>
                <label>Personal Notes<textarea name="notes" rows="2" placeholder="Your thoughts, memories, or notes about this game..."></textarea></label>

                <!-- Container for fields that are different in bulk edit mode -->
                <div id="bulk-edit-specific-fields"></div>

                <div class="inline-radios">
                    <span>Type:</span>
                    <label><input type="radio" name="game_type" value="original" checked> Original Game</label>
                    <label><input type="radio" name="game_type" value="derived"> Remake / Remaster</label>
                    <label><input type="radio" name="game_type" value="sequel"> Sequel</label>
                </div>
                <div id="link-game-section" style="display:none;">
                    <label>Link to Original Game
                        <input type="text" name="related_game_id" placeholder="Enter game ID or name">
                    </label>
                    <button type="button" id="btn-link-game" class="btn btn-sm">Find & Link</button>
                </div>
                <div id="game-platforms-section">
                    <label class="label-with-button"><span>Associated Platforms (immediately saved)</span><button type="button" id="btn-associate-platform" class="btn btn-sm">Associate with Platform</button></label>
                    <ul id="game-platforms-list" class="item-list pills">
                        <!-- JS will populate this list -->
                    </ul>
                </div>
                <div class="modal-actions">
                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">Save</button>
                        <button type="button" class="btn" data-close>Cancel</button>
                    </div>
                    <div class="button-group">
                        <button type="button" class="btn btn-clone">Clone</button>
                        <button type="button" class="btn btn-delete">Delete</button>
                    </div>
                </div>
            </form>
        </div>

    </div>

    <!-- Add Game to Platform Modal -->
    <div id="modal-add-to-platform" class="modal" aria-hidden="true">
        <div class="modal-content">
            <header class="modal-header">
                <h2>Add Game to Platform</h2>
                <button class="modal-close" data-close>&times;</button>
            </header>
            <form id="form-add-to-platform" class="modal-form">
                <div>
                    <div class="label-with-button" style="margin-bottom: 8px;">
                        <label>Platform:</label>
                        <div class="sort-controls">
                            <span>Sort by:</span>
                            <select id="platform-sort-select">
                                <option value="name_asc">Name (A-Z)</option>
                                <option value="name_desc">Name (Z-A)</option>
                                <option value="count_desc">Games (Most)</option>
                                <option value="count_asc">Games (Fewest)</option>
                            </select>
                        </div>
                    </div>
                    <div id="platform-radio-group" class="pill-group">
                        <!-- JS will populate platform radio options -->
                    </div>
                </div>
                <div id="format-section">
                    <label>Format:</label>
                    <div id="format-checkbox-group" class="pill-group">
                        <!-- JS will populate format checkboxes based on platform support -->
                    </div>
                </div>
                <div>
                    <label>Acquired:</label>
                    <div id="acquisition-method-group" class="pill-group"></div>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">Add</button>
                    <button type="button" class="btn" data-close>Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add / Edit Platform Modal -->
    <div id="modal-platform" class="modal" aria-hidden="true">
        <div class="modal-content">
            <header class="modal-header">
                <h2 id="modal-platform-title">Add / Edit Platform</h2>
                <button class="modal-close" data-close>&times;</button>
            </header>
            <form id="form-platform" class="modal-form" data-id-holder>
                <label>Platform Name<input type="text" name="name" required></label>
                <div class="inline-checkboxes">
                    <span>Supported Formats:</span>
                    <label><input type="checkbox" name="supports_digital" checked> Digital</label>
                    <label><input type="checkbox" name="supports_physical"> Physical</label>
                </div>
                <label>Description<textarea name="description"></textarea></label>
                <label>Icon URL<input type="text" name="icon_url" placeholder="e.g., /img/icon.svg or https://..."></label>
                <label>Image URL<input type="text" name="image_url" placeholder="e.g., /img/banner.jpg or https://..."></label>
                <label>Year Acquired<input type="number" name="year_acquired" min="1980" max="2100"></label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <label>Generation<input type="text" name="generation" placeholder="e.g., 7th Gen, 8th Gen, Retro"></label>
                    <label>Manufacturer<input type="text" name="manufacturer" placeholder="e.g., Sony, Microsoft, Nintendo"></label>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn" data-close>Cancel</button>
                    <button type="button" class="btn btn-clone" style="margin-left: auto;">Clone</button>
                    <button type="button" class="btn btn-delete">Delete</button>
                </div>
            </form>
        </div>
    </div>

    <!-- CSV Import Modal -->
    <div id="modal-import" class="modal" aria-hidden="true">
        <div class="modal-content" style="max-width:90vw;width:90vw;">
            <header class="modal-header">
                <h2>Import from CSV</h2>
                <button class="modal-close" data-close>&times;</button>
            </header>
            <div class="modal-body" style="display:flex;flex-direction:column;gap:12px;max-height:85vh;overflow-y:auto;">
                <div>
                    <input id="csv-file-input" type="file" accept="text/csv" />
                    <p class="muted">Upload a CSV file or paste CSV text. You will be able to map columns before importing.</p>
                </div>
                <textarea id="csv-textarea" rows="6" placeholder="Paste CSV here or choose a file" style="width:100%;box-sizing:border-box;"></textarea>
                <div>
                    <h4>Column Mapping</h4>
                    <div id="csv-mapping" class="csv-mapping" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;">
                        <!-- Mapping UI will be injected here: header -> db field select -->
                    </div>
                </div>
                <div>
                    <h4>Preview</h4>
                    <div id="csv-preview-table" style="max-height:200px;overflow:auto;border:1px solid var(--muted);padding:6px;background:var(--panel-bg);"></div>
                </div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <label style="white-space:nowrap">On duplicate:</label>
                    <select id="import-duplicate-policy">
                        <option value="create_new">Create new</option>
                        <option value="skip">Skip</option>
                        <option value="merge">Merge</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button id="btn-run-import" class="btn btn-primary">Run Import</button>
                    <button class="btn" data-close>Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Edit Modal -->
    <div id="modal-bulk-edit" class="modal" aria-hidden="true">
        <div class="modal-content">
            <header class="modal-header">
                <h2>Bulk Edit <span id="bulk-edit-count"></span> Items</h2>
                <button class="modal-close" data-close>&times;</button>
            </header>
            <div id="form-bulk-edit" class="modal-form">
                <p>Choose an action to apply to all selected items. This cannot be undone.</p>

                <div id="bulk-actions-container">
                    <div class="bulk-action-button-row">
                        <button class="btn" data-action="assign_platform">Assign to Platform</button>
                        <select name="bulk_platform_id" id="bulk-assign-platform-select">
                            <!-- JS will populate platforms -->
                        </select>
                    </div>
                    <div class="bulk-action-button-row">
                        <button class="btn" data-action="remove_platform">Remove from Platform</button>
                        <select name="bulk_platform_id_remove" id="bulk-remove-platform-select">
                            <!-- JS will populate platforms -->
                        </select>
                    </div>
                    <button id="bulk-btn-edit-fields" class="btn" data-action="edit_fields">Edit Game Fields...</button>
                    <button id="bulk-btn-delete" class="btn btn-danger" data-action="delete">Delete Selected Items</button>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn" data-close>Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Modal -->
    <div id="modal-filter" class="modal" aria-hidden="true">
        <div class="modal-content">
            <header class="modal-header">
                <h2>Filter Games</h2>
                <button class="modal-close" data-close>&times;</button>
            </header>
            <form id="form-filter" class="modal-form">
                <div style="display:flex;align-items:center;gap:8px">
                    <div style="flex:1">
                        <label>Search by Name, Tag or Keyword</label>
                        <input type="text" id="filter-keyword" placeholder="e.g., Zelda, action, RPG...">
                    </div>
                    <div class="help-icon" tabindex="0" aria-label="Search help">?
                        <div class="help-tooltip">Type "exact phrase" for exact match; otherwise multiple words are treated as AND.</div>
                    </div>
                </div>

                <div>
                    <div class="label-with-button" style="margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <label>Filter by Platform</label>
                            <div class="pill-group" style="padding-top: 0;">
                                <input type="radio" name="platform_mode" value="or" id="platform_mode_or">
                                <label for="platform_mode_or">Any (OR)</label>
                                <input type="radio" name="platform_mode" value="and" id="platform_mode_and">
                                <label for="platform_mode_and">All (AND)</label>
                            </div>
                        </div>
                        <div class="sort-controls">
                            <span>Sort by:</span>
                            <select id="filter-platform-sort-select">
                                <option value="name_asc">Name (A-Z)</option>
                                <option value="name_desc">Name (Z-A)</option>
                                <option value="count_desc">Games (Most)</option>
                                <option value="count_asc">Games (Fewest)</option>
                            </select>
                        </div>
                    </div>
                    <div id="filter-platforms" class="pill-group scrollable-pill-group">
                        <!-- JS will populate platform checkboxes -->
                    </div>
                </div>

                <div>
                    <div class="label-with-button" style="margin-bottom: 8px;">
                        <label>Filter by Tags</label>
                        <div class="sort-controls">
                            <span>Sort by:</span>
                            <select id="filter-tag-sort-select">
                                <option value="name_asc">Name (A-Z)</option>
                                <option value="name_desc">Name (Z-A)</option>
                                <option value="count_desc">Usage (Most)</option>
                                <option value="count_asc">Usage (Fewest)</option>
                            </select>
                        </div>
                    </div>
                    <div id="filter-tags" class="pill-group scrollable-pill-group">
                        <!-- JS will populate tag checkboxes -->
                    </div>
                </div>

                <div>
                    <label>Filter by Type</label>
                    <div id="filter-game-type" class="pill-group">
                        <!-- JS will populate game type status checkboxes -->
                    </div>
                </div>

                <div>
                    <label>Filter by ESRB Rating</label>
                    <div id="filter-esrb-rating" class="pill-group">
                        <!-- JS will populate ESRB rating checkboxes -->
                    </div>
                </div>

                <div>
                    <div class="label-with-button" style="margin-bottom: 8px;">
                        <label>Filter by Genre</label>
                        <div class="sort-controls">
                            <span>Sort by:</span>
                            <select id="filter-genre-sort-select">
                                <option value="name_asc">Name (A-Z)</option>
                                <option value="name_desc">Name (Z-A)</option>
                                <option value="count_desc">Usage (Most)</option>
                                <option value="count_asc">Usage (Fewest)</option>
                            </select>
                        </div>
                    </div>
                    <div id="filter-genres" class="pill-group scrollable-pill-group">
                        <!-- JS will populate genre checkboxes -->
                    </div>
                </div>

                <div>
                    <div class="label-with-button" style="margin-bottom: 8px;">
                        <label>Filter by Target Audience</label>
                        <div class="sort-controls">
                            <span>Sort by:</span>
                            <select id="filter-audience-sort-select">
                                <option value="name_asc">Name (A-Z)</option>
                                <option value="name_desc">Name (Z-A)</option>
                                <option value="count_desc">Usage (Most)</option>
                                <option value="count_asc">Usage (Fewest)</option>
                            </select>
                        </div>
                    </div>
                    <div id="filter-audiences" class="pill-group scrollable-pill-group">
                        <!-- JS will populate target audience checkboxes -->
                    </div>
                </div>

                <div>
                    <div class="label-with-button" style="margin-bottom: 8px;">
                        <label>Filter by Acquisition Method</label>
                        <div class="sort-controls">
                            <span>Sort by:</span>
                            <select id="filter-acquisition-sort-select">
                                <option value="name_asc">Name (A-Z)</option>
                                <option value="name_desc">Name (Z-A)</option>
                                <option value="count_desc">Usage (Most)</option>
                                <option value="count_asc">Usage (Fewest)</option>
                            </select>
                        </div>
                    </div>
                    <div id="filter-acquisition" class="pill-group scrollable-pill-group"></div>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">Apply Filters</button>
                    <button type="button" id="btn-clear-filters" class="btn">Clear All</button>
                    <button type="button" class="btn" data-close>Close</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Display Modal -->
    <div id="modal-display" class="modal" aria-hidden="true">
        <div class="modal-content">
            <header class="modal-header">
                <h2>Card Display Options</h2>
                <button class="modal-close" data-close>&times;</button>
            </header>
            <form id="form-display" class="modal-form">
                <div class="inline-checkboxes">
                    <label><input type="checkbox" name="show_cover" checked> Cover Art</label>
                    <label><input type="checkbox" name="show_title" checked disabled title="Title is always shown"> Title (always shown)</label>
                    <label><input type="checkbox" name="show_description" checked> Description</label>
                    <label><input type="checkbox" name="show_tags" checked> Tags</label>
                    <label><input type="checkbox" name="show_platforms" checked> Platforms</label>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">Apply</button>
                    <button type="button" class="btn" data-close>Close</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Orphaned Games Handler Modal -->
    <div id="modal-orphan-handler" class="modal" aria-hidden="true">
        <div class="modal-content">
            <header class="modal-header">
                <h2>Handle Orphaned Games</h2>
                <button class="modal-close" data-close>&times;</button>
            </header>
            <form id="form-orphan-handler" class="modal-form">
                <p id="orphan-info-text">Deleting this platform will orphan games. What would you like to do?</p>
                <div class="inline-radios vertical">
                    <label>
                        <input type="radio" name="orphan_action" value="delete" checked>
                        Delete the platform and orphan the games.
                    </label>
                    <label>
                        <input type="radio" name="orphan_action" value="remap">
                        Move the games to an existing platform:
                        <select name="remap_platform_id" id="orphan-remap-select" disabled>
                            <!-- JS will populate -->
                        </select>
                    </label>
                    <label>
                        <input type="radio" name="orphan_action" value="new">
                        Move the games to a new temporary platform named:
                        <input type="text" name="new_platform_name" id="orphan-new-name" disabled>
                    </label>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">Proceed</button>
                    <button type="button" class="btn" data-close>Cancel</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module" src="/js/main.js"></script>
</body>
</html>
